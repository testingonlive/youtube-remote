<!DOCTYPE html>
<html>
    <head>
        <style>
            /* css i'll move at some point */
            html, body {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;  
            }

            body {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            }

            iframe {
                transition: box-shadow 750ms;
            }

            iframe.playing {
                box-shadow: 0 0 45px 30px grey;
            }
      
      
          </style>
    </head>
    
  <body>
      
      
      
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
    </script>
      
      
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div>
    <span>Go to "http://jacob-bandit-3000.codio.io/remote#<span id="js-room"></span>" to use the remote</span>
     

    <script>
      // use promise based code for shits and giggles
      var promiseYTAPI = function( url ) {
    
          // return a new promise
          return new Promise(function( resolve, reject ){

              // create the script element
              var scriptElm = document.createElement( 'script' );
              scriptElm.type = 'text/javascript';
              scriptElm.async = true;

              // reject onerror
              scriptElm.onerror = function( err ){
                  reject( err );
              }

              // The youtube API requires this function so we oblige
              window.onYouTubeIframeAPIReady = function(){
                  resolve();
              }

              // do the stuff to actually get the script
              document.head.appendChild( scriptElm );
              scriptElm.src = url;

            });  
      };
          
          
        promiseYTAPI( 'https://www.youtube.com/iframe_api' ).then(function(){
            
            var player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: 'M7lc1UVf-VE',         
            });
            
            var _iframe =  document.querySelector( 'iframe' );
            
            player.addEventListener( 'onReady', function( event ){
                var playing = false; 
          
               
                socket.emit( 'requestRoom', function( room ){
                    document.querySelector( '#js-room' ).textContent = room;
                    console.log( room );
                })
          
                socket.on( 'start', function(){
                    
                    if ( playing = !playing ) {
                        _iframe.classList.add( 'playing' );
                        event.target.playVideo();
                    } else{
                        _iframe.classList.remove( 'playing' );
                        event.target.pauseVideo();
                    } 
                });
                
                socket.on( 'skip', function( data ){
                    player.seekTo( points[ data ].time, true );
                });
          
          
                requestAnimationFrame( function _frame(){
                    
                    var _time = player.getCurrentTime();
                    emitPoint( _time, points );
                    
                    requestAnimationFrame( _frame );
                });
                
                
            });
            
        }); 
          
          
        // hardcode some data for the sake to testing
        var points = [
               {
                id: 0,
                time: 10,
                name: 'Frank'
            },
            {
                id: 1,
                time: 20,
                name: 'Bob'
            },
            {
                id: 2,
                time: 30,
                name: 'Alice'
            },
            {
                id: 3,
                time: 40,
                name: 'Rita'
            }
        ];
          
          
        emitPoint = function( time, points ){            
            
            if ( !emitPoint.justDone ){
                points.some( function( elm ){
                    if ( Math.abs( elm.time - time ) < 0.5 ){
                        console.log( elm );
                        
                        socket.emit( 'point', elm );

                        setTimeout( function(){
                            emitPoint.justDone = false
                        }, 2e3 );

                        return emitPoint.justDone = true;
                    }
                });
            }
        };
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
        
        

     
    </script>
  </body>
</html>